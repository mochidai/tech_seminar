# ブラウザにURLを打ち込むと何が起きるか
* アドレスバーに `https://www.shibaura-it.ac.jp/`と入力した後、コンピュータは何をするか？
  * DNSを利用したwww.shibaura-it.ac.jpのアドレス問い合わせ
  * HTTPSを利用したリクエスト・レスポンスのやりとり
## DNS
* DNS ( Domain Name System ) は、ドメイン名（コンピュータを識別する名称）をIPアドレスに自動的に変換してくれるアプリケーション層プロトコルである。
  * www.shibaura-it.ac.jp -> 153.120.129.227
* ブラウザは、www.shibaura-it.ac.jpのIPアドレスをDNSサーバに問い合わせる。
  * 学内からは学内のDNSサーバに聞く
  * ターミナルから`dig`や`nslookup`コマンドを利用して調べることが出来る。

## DNSサーバの仕組み
1. クライアントがDNSリゾルバに`www.shibaura-it.ac.jp`のIPアドレスを問い合わせる
2. DNSリゾルバがIPアドレスを知らない場合、`.jp`の権威DNSサーバに問い合わせる。
   * 学内の場合、ここで終わることが多い。
3. `.jp`の権威DNSサーバは`.ac.jp`の権威DNSサーバのIPアドレスを回答する。
4. `.ac.jp`の権威DNサーバは`.shibaura-it.ac.jp`のDNSサーバのIPアドレスを回答する。
5. `.shibaura-it.ac.jp`のDNSサーバは、`www.shibaura-it.ac.jp`のIPアドレスを回答する。
6. DNSリゾルバは、`www.shibaura-it.ac.jp`のIPアドレス`153.120.129.227`をクライアントに回答する。
   
## クライアントのブラウザにURLを打ち込んだ後の処理
1. クライアントはDNSリゾルバにホストネーム(www.shibaura-it.ac.jp)のIPアドレスを問い合わせる。
2. DNSリゾルバは、ルートネームサーバ（Root Name Server)にDNSクエリを送る。
   1. ルートネームサーバは、この場合、トップレベルドメインのネームサーバ（TLD Nameserver, この場合は.jp）になる。
3. DNSリゾルバは、.jp から始まる再帰的な問い合わせによってルートネームサーバから順次IPアドレスを受け取る。
4. ドメインネームサーバ(この場合はshibaura-it.ac.jpを管理するサーバ)がwww.shibaura-it.ac.jpのIPアドレスを返す。
5. DNSリゾルバは、`www.shibaura-it.ac.jp`のIPアドレス`153.120.129.227`をクライアントに回答する。

## DNSのプライバシー
* DNSクエリはplaintext
* ISPはこのデータが売れることを知っている
* プロの小技（？）：DNSの設定をパブリックDNSに変える
  * 8.8.8.8 : Google の提供するパブリックDNS
  * 1.1.1.1 : Cloudflare の提供するパブリックDNS
  * GoogleもCloudflareも売るのでは無いか・・・・つきない不安

## HTTPを利用したリクエスト・レスポンスのやりとり
* TCP/443による3ウェイハンドシェイク (UDP/443 QUICもある)
* Webサーバの証明書を確認
* TLSを使用してHTTPメッセージをやりとりする。


## DNSハイジャック
* DNSリゾルバに異なる権威DNSサーバを教える
* DNSリゾルバは、悪意のある偽物の権威DNSサーバと通信する
* クライアントとDNSリゾルバは偽物の通信先のIPアドレスを入手する
  * DNSリゾルバは偽物のIPアドレスをキャッシュする。キャッシュ後は、別クライアントの通信も偽物のサーバに送られる。
* そのほかにも、権威DNSサーバのデータを書き換える、レジストリの情報（.jpに登録されている情報）を書き換える等の手法がある。
* 対策：DNSSECの有効化、DNS Cookie

# DEMO
## やりたいこと
1. JavascriptでSocketをつかってexample.comとTwitter.comからファイルを転送する。
2. Node.jsをつかって認証が必要なWebサイトを作り、Cookieの脆弱性を実証する。

## Javascript でHTTPクライアントをつくり、データを取得する
STEPS
* TCP SOCKETを開く
* HTTPリクエストを書いて、SOCKETで送る
* HTTPレスポンスをSOCKETから読む

## TCP SOCKETを開く
まず、netパッケージを使ってTCPパケットをつくる

```
const net = require('net')

const socket = net createConnection({
    host: 'example.com',
    port: 80
})

(request:あとで定義する)

socket.write(request)
```

## request の中身を書く
次に、requestの中身を書く。
HTTPでGETメソッドを使う。
slice(1)は改行を飛ばすための工夫である。

```
const request = `
    GET / HTTP/1.1
    Host:example.com

`.slice(1)

```
## DNSクエリを入れる
```
const net = require('net')
const dns = require('dns')

dns.lookup('example.com', (err, address) => {
        if (err) throw err

        const socket = net.createConnection({
            host: address, 
            port: 80
        })


const request = `
GET / HTTP/1.1
Host: example.com

`.slice(1)

socket.write(request)
socket.pipe(process.stdout)
        
}
)

```

## DNS

```
const net = require('net')
const dns = require('dns')

dns.lookup('example.com', (err, address) => {
        if (err) throw err

        const socket = net.createConnection({
            host: address, 
            port: 80
        })


const request = `
GET / HTTP/1.1
Host: example.com

`.slice(1)

socket.write(request)
socket.pipe(process.stdout)
        
}
)

```

# Node.jsをつかって認証が必要なWebサイトを作り、Cookieの脆弱性を実証する。

## HTMLでログインのページをつくる

* 例えば銀行のログインページを考える
* 必要なのはusername / passwordを入れて送るフォーム

```
<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Bank login</title>
    </head>
    <body>
    <h1>Login to your bank account:</h1>
        <form method='POST' action='/login'>
            Username:
            <input name='username' />

            Password:
            <input name="password" type="password" />
            <input type='submit' value='login' />
        </form>
    </body>
</html>
```

## Javascript でサーバをつくる
* server.js でやりたいこと
  * username/passwordを検証し、認証するWebサイトをつくる
  * nodemon を使うと更新した後にサーバをたちげる必要が無い
  
### Step 1 Node.jsとExpressでログインページをつくる
  * 簡易なWebサーバをExpressで立てるサーバを立てる
  * port 4000 でリクエストを待つ
  * url '/'でログイン画面を返す
  * url '/login' でログインの結果を返す

```
const express = require('express')
const {creatReadStream} = require('fs')
// const createReadStream = require('fs').createReadStream　とおなじ
const app = express()

app.get('/', (req, res) => {
createReadStream('index.html').pipe(res)
})

app.get('/login', (req, res) => {

})

app.listen(4000)
```

### Step2 入力されたusername/passowrd を取り出す

* bodyParserを使うことで、username/passowordをコンソールで確認できるようにする
* 
```
const express = require('express')
const {creatReadStream} = require('fs')
// const createReadStream = require('fs').createReadStream　とおなじ
const bodyParser = require('body-parser')


const app = express()
app.use(bodyParser.urlencoded({ extended:false }))

app.get('/', (req, res) => {
createReadStream('index.html').pipe(res)
})

app.get('/login', (req, res) => {
console.log(req.body)
})

app.listen(4000)
```
### Step3 username/password のデータベースをつくる

* USERSデータベースをつくる
* 認証が成功するか確認する
```
const express = require('express')
const {creatReadStream, createReadStream} = require('fs')
const bodyParser = require('body-parser')

const USERS ={
    alice: 'password',
    bob: 'hunter2'
}

const app = express()
app.use(bodyParser.urlencoded({ extended: false }))

app.get('/', (req, res) => {
    createReadStream('index.html').pipe(res)
})

app.post('/login', (req, res)=>{
    const username = req.body.username
    const password = USERS[username]
    if (req.body.password === password){
        res.send('Nice!')
    } else {
        res.send('Fail!')
    }
})
app.listen(4000)
```

### Step4 cookiesを使うことで、認証情報を保存する


```
const express = require('express')
const {creatReadStream, createReadStream} = require('fs')
const bodyParser = require('body-parser')
const cookieParser = require('cookie-parser')

const USERS ={
    alice: 'password',
    bob: 'hunter2'
}

const app = express()
app.use(bodyParser.urlencoded({ extended: false }))
app.use(cookieParser())

app.get('/', (req, res) => {
    const username  = req.cookies.username
    if (username) {
        res.send(`Hi ${username}!`)
    } else {
    createReadStream('index.html').pipe(res)
    }
})

app.post('/login', (req, res)=>{
    const username = req.body.username
    const password = USERS[username]
    if (req.body.password === password){
        res.cookie('username', username)
        res.send('Nice!')
    } else {
        res.send('Fail!')
    }
})
app.listen(4000)
```

### Step5 ブラウザのcookieを操作することで、違う人になりすますことを示す
* Google Chrome で DevTool>Application >Cookies: http://localhost:4000 > username:bob
* 